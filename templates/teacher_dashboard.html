<!-- templates/teacher_dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="teacher-dashboard">
    <!-- Navigation Bar -->
    <nav class="main-nav">
        <div class="nav-brand">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
            </svg>
            <span>AI Quiz Teacher</span>
        </div>
        <div class="nav-menu">
            <a href="#" class="nav-link" data-tab-target="overview-tab">Overview</a>
            <a href="#" class="nav-link" data-tab-target="quizzes-tab">Quizzes</a>
            <a href="#" class="nav-link" data-tab-target="students-tab">Students</a>
            <a href="#" class="nav-link" data-tab-target="activity-tab">Activity</a>
            <form action="{{ url_for('auth.logout') }}" method="post" onsubmit="return confirm('Are you sure you want to logout?');" style="display:inline;margin:0;padding:0;">
                <button type="submit" class="nav-link" style="background:none;border:none;padding:0;display:inline-flex;align-items:center;gap:0.5rem;cursor:pointer;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    Logout
                </button>
            </form>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-content" style="padding: 2rem; background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
            <header class="dashboard-header" id="profile">
                <div>
                    <h1 style="color: var(--slate-900); margin-bottom: 0.5rem;">Teacher Dashboard</h1>
                    <p style="color: var(--slate-600); font-size: 1.125rem;">Welcome back, {{ username }}!</p>
                </div>
                <div class="actions" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <a href="{{ url_for('teacher.create_quiz') }}" class="btn btn-primary" title="Create a new quiz" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                        Create Quiz
                    </a>
                    <button type="button" id="export-quizzes-btn" class="btn btn-secondary" title="Export quizzes as CSV" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Export CSV
                    </button>
                    <a href="{{ url_for('teacher.analytics') }}" class="btn btn-secondary" title="View analytics" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M7 13l3 3L22 4"/></svg>
                        Analytics
                    </a>
                </div>
            </header>

            <!-- Tabs content -->
            <div class="tab-panels">
                <!-- Overview -->
                <section id="overview-tab" class="tab-content active">
                    <section class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>
                                <h3>Total Quizzes</h3>
                            </div>
                            <div class="stat-value">{{ quiz_count }}</div>
                            <div class="stat-label">Active quizzes in your account</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                                <h3>Total Students</h3>
                            </div>
                            <div class="stat-value">{{ student_count }}</div>
                            <div class="stat-label">Students taking your quizzes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                <h3>Recent Activity</h3>
                            </div>
                            <div class="activity-timeline">
                                {% for activity in recent_activity %}
                                <div class="activity-item">
                                    <div class="activity-content">
                                        <div class="activity-title">{{ activity }}</div>
                                        <div class="activity-time">Just now</div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="activity-item"><div class="activity-content"><div class="activity-title">No recent activity</div><div class="activity-time">-</div></div></div>
                                {% endfor %}
                            </div>
                        </div>
                    </section>
                </section>

                <!-- Quizzes -->
                <section id="quizzes-tab" class="tab-content">
                    <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem; flex-wrap: wrap;">
                        <input type="text" id="quiz-search" placeholder="Search quizzes..." style="padding: 0.5rem 1rem; border-radius: 0.4rem; border: 1px solid #cbd5e1; font-size: 1rem; width: 250px;">
                        <select id="quiz-sort" style="padding: 0.5rem 1rem; border-radius: 0.4rem; border: 1px solid #cbd5e1;">
                            <option value="newest">Newest</option>
                            <option value="oldest">Oldest</option>
                            <option value="title">Title A→Z</option>
                            <option value="questions">Most Questions</option>
                        </select>
                    </div>
                    {% if quizzes %}
                    <div class="quiz-grid" id="quiz-grid">
                        {% for quiz in quizzes %}
                        <div class="quiz-card" data-title="{{ quiz.title|lower }}" data-questions="{{ quiz.question_count }}" data-created="{{ quiz.created_at }}" style="text-decoration: none;">
                            <a href="{{ url_for('teacher.quiz_details', quiz_id=quiz.id) }}" style="text-decoration: none; color: inherit;">
                                <div class="quiz-card-content">
                                    <h3 class="quiz-title">{{ quiz.title }}</h3>
                                    <div class="quiz-card-details">
                                        <span>{{ quiz.question_count }} Questions</span>
                                        <span>{{ quiz.time_limit }} min</span>
                                    </div>
                                </div>
                            </a>
                            <div class="quiz-card-footer" style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                    <span style="font-size: 0.875rem; color: var(--primary-200);">Room Code</span>
                                    <p class="room-code" id="room-code-{{ quiz.id }}" style="display: inline; margin: 0;">{{ quiz.room_code }}</p>
                                    <button type="button" class="btn btn-sm btn-secondary" style="padding: 0.2rem 0.5rem; font-size: 0.95rem; border-radius: 0.3rem; display: flex; align-items: center;" title="Copy Room Code" onclick="navigator.clipboard.writeText('{{ quiz.room_code }}')">Copy</button>
                                    <button type="button" class="btn btn-sm btn-secondary" style="padding: 0.2rem 0.5rem; font-size: 0.95rem; border-radius: 0.3rem; display: flex; align-items: center;" title="Share Join Link" onclick="navigator.clipboard.writeText(window.location.origin + '/student/dashboard?room_code={{ quiz.room_code }}')">Share Link</button>
                                </div>
                                <a href="{{ url_for('teacher.quiz_answers', quiz_id=quiz.id) }}" class="btn btn-sm btn-info" style="margin-top: 0.2rem; font-size: 0.95rem; background: #e0e7ff; color: #3730a3; font-weight: 600; border-radius: 0.4rem; padding: 0.3rem 0.9rem; text-align: center;">View Answers</a>
                                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                                    <a href="{{ url_for('teacher.create_quiz') }}?edit={{ quiz.id }}" class="btn btn-sm btn-secondary">Edit</a>
                                    <a href="{{ url_for('teacher.create_quiz') }}?duplicate={{ quiz.id }}" class="btn btn-sm btn-secondary">Duplicate</a>
                                    <form method="post" action="{{ url_for('teacher.api_delete_quiz', quiz_id=quiz.id) }}" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="text-align: center; padding: 5rem 1.5rem; background-color: white; border-radius: 0.5rem; border: 2px dashed var(--slate-300);">
                        <h3 style="margin-top: 1rem; font-size: 1.25rem; font-weight: 500;">No quizzes created yet</h3>
                        <p style="margin-top: 0.5rem; color: var(--slate-500);">Get started by creating your first AI-powered quiz.</p>
                        <a href="{{ url_for('teacher.create_quiz') }}" class="btn btn-primary" style="margin-top: 1.5rem;">Create Quiz</a>
                    </div>
                    {% endif %}
                </section>

                <!-- Students -->
                <section id="students-tab" class="tab-content">
                    <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
                        <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--slate-900); display: flex; align-items: center; gap: 0.5rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            Your Students
                        </h2>
                        <div style="display:flex; gap: 0.5rem; align-items:center;">
                            <input id="student-search" type="text" placeholder="Search students..." style="padding: 0.5rem 1rem; border: 1px solid var(--slate-200); border-radius: 0.5rem; width: 250px;">
                            <select id="student-sort" style="padding: 0.5rem 1rem; border: 1px solid var(--slate-200); border-radius: 0.5rem;">
                                <option value="name">Name A→Z</option>
                                <option value="score">Highest Avg</option>
                            </select>
                        </div>
                    </div>

                    {% if student_performance %}
                    <div class="dashboard-table">
                        <table id="students-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    <th>ID</th>
                                    <th>Performance</th>
                                    <th>Last Quiz</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for student in student_performance %}
                                <tr data-name="{{ student.username|lower }}" data-score="{{ student.avg_score if student.avg_score is not none else 0 }}">
                                    <td style="font-weight: 500;">{{ student.username }}</td>
                                    <td>{{ student.id }}</td>
                                    <td>
                                        {% if student.avg_score is not none %}
                                        <div class="score-badge {% if student.avg_score >= 70 %}score-high{% elif student.avg_score >= 40 %}score-medium{% else %}score-low{% endif %}">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20V10M18 20V4M6 20v-4"/></svg>
                                            {{ "%.1f"|format(student.avg_score) }}% Average
                                        </div>
                                        {% else %}
                                        <span class="text-muted">No attempts</span>
                                        {% endif %}
                                    </td>
                                    <td style="color: var(--slate-600);">{{ student.last_quiz if student.last_quiz else '-' }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-secondary" style="padding: 0.25rem 0.75rem;" onclick="alert('Coming soon: detailed progress report')">View Progress</button>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="empty-state" style="text-align: center; padding: 3rem; background: white; border-radius: 1rem; border: 2px dashed var(--slate-200);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin: 0 auto 1rem; color: var(--slate-400);">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        <p style="color: var(--slate-600); font-size: 1.1rem;">No students found</p>
                        <p style="color: var(--slate-500); margin-top: 0.5rem;">Share your quiz room code with students to get started</p>
                    </div>
                    {% endif %}
                </section>

                <!-- Activity -->
                <section id="activity-tab" class="tab-content">
                    <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--red-700); display: flex; align-items: center; gap: 0.5rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                            Suspicious Activity Monitor
                        </h2>
                    </div>
                    <div class="activity-log" style="background: linear-gradient(to right, var(--red-50), white); border-radius: 1rem; overflow: hidden;">
                        <div class="activity-list" style="padding: 1.5rem;">
                            {% if suspicious_logs %}
                            <div class="activity-grid" style="display: grid; gap: 1rem;">
                                {% for log in suspicious_logs %}
                                <div class="activity-item" style="background: white; padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--red-200);">
                                    <div class="activity-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <span style="font-weight: 600; color: var(--red-700);">{{ log.username }}</span>
                                        <span style="font-size: 0.875rem; color: var(--slate-500);">{{ log.timestamp|datetime }}</span>
                                    </div>
                                    <div class="activity-details" style="display: grid; gap: 0.5rem;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>
                                            <span>Quiz: <strong>{{ log.title }}</strong></span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                            <span>Student ID: {{ log.student_id }}</span>
                                        </div>
                                        <div class="alert-badge" style="display: inline-flex; align-items: center; gap: 0.5rem; background: var(--red-100); color: var(--red-700); padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                                            {% if log.action == 'plagiarism_detected' %}Plagiarism Detected
                                            {% elif log.action == 'tab_switch' %}Tab/Window Switch
                                            {% elif log.action == 'rapid_change' %}Rapid Answer Changes
                                            {% elif log.action == 'multi_login_ip' %}Multiple Logins (Different IP)
                                            {% elif log.action == 'failed_login' %}Failed Login Attempt
                                            {% elif log.action == 'fast_completion' %}Very Fast Quiz Completion
                                            {% elif log.action == 'excessive_tab_switch' %}Excessive Tab/Window Switches
                                            {% elif log.action == 'js_disabled' %}JavaScript Disabled
                                            {% elif log.action == 'unusual_pattern' %}Unusual Answer Pattern
                                            {% else %}{{ log.action }}{% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="empty-state" style="text-align: center; padding: 2rem;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin: 0 auto 1rem; color: var(--slate-400);"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                                <p style="color: var(--slate-600);">No suspicious activity detected</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
    // Tab system and filters/sorts for quizzes and students
    (function(){
        const links = document.querySelectorAll('.nav-link[data-tab-target]');
        const tabs = document.querySelectorAll('.tab-content');
        function activateTab(id){
            tabs.forEach(t => t.classList.remove('active'));
            const el = document.getElementById(id);
            if (el) el.classList.add('active');
            links.forEach(l => l.classList.remove('active'));
            Array.from(links).find(l => l.getAttribute('data-tab-target') === id)?.classList.add('active');
        }
        links.forEach(l => l.addEventListener('click', function(e){ e.preventDefault(); activateTab(this.getAttribute('data-tab-target')); }));
        // Default to overview
        activateTab('overview-tab');

        // Quiz search and sort
        const grid = document.getElementById('quiz-grid');
        const searchInput = document.getElementById('quiz-search');
        const sortSelect = document.getElementById('quiz-sort');
        function applyQuizFilters(){
            if (!grid) return;
            const cards = Array.from(grid.children);
            const term = (searchInput?.value || '').toLowerCase();
            cards.forEach(c => {
                const title = c.getAttribute('data-title') || '';
                c.style.display = title.indexOf(term) > -1 ? '' : 'none';
            });
            const visible = cards.filter(c => c.style.display !== 'none');
            const sortBy = sortSelect?.value || 'newest';
            visible.sort((a, b) => {
                if (sortBy === 'title') return (a.getAttribute('data-title')||'').localeCompare(b.getAttribute('data-title')||'');
                if (sortBy === 'questions') return (parseInt(b.getAttribute('data-questions')||'0') - parseInt(a.getAttribute('data-questions')||'0'));
                if (sortBy === 'oldest') return (a.getAttribute('data-created')||'').localeCompare(b.getAttribute('data-created')||'');
                return (b.getAttribute('data-created')||'').localeCompare(a.getAttribute('data-created')||'');
            });
            visible.forEach(c => grid.appendChild(c));
        }
        searchInput?.addEventListener('input', applyQuizFilters);
        sortSelect?.addEventListener('change', applyQuizFilters);
        applyQuizFilters();

        // Students search and sort
        const studentSearch = document.getElementById('student-search');
        const studentSort = document.getElementById('student-sort');
        const studentsTable = document.getElementById('students-table')?.querySelector('tbody');
        function applyStudentFilters(){
            if (!studentsTable) return;
            const rows = Array.from(studentsTable.querySelectorAll('tr'));
            const term = (studentSearch?.value || '').toLowerCase();
            rows.forEach(r => {
                const name = r.getAttribute('data-name')||'';
                r.style.display = name.indexOf(term) > -1 ? '' : 'none';
            });
            const visible = rows.filter(r => r.style.display !== 'none');
            const sortBy = studentSort?.value || 'name';
            visible.sort((a, b) => {
                if (sortBy === 'score') return parseFloat(b.getAttribute('data-score')||'0') - parseFloat(a.getAttribute('data-score')||'0');
                return (a.getAttribute('data-name')||'').localeCompare(b.getAttribute('data-name')||'');
            });
            visible.forEach(r => studentsTable.appendChild(r));
        }
        studentSearch?.addEventListener('input', applyStudentFilters);
        studentSort?.addEventListener('change', applyStudentFilters);
        applyStudentFilters();

        // Export quizzes CSV
        const exportBtn = document.getElementById('export-quizzes-btn');
        exportBtn?.addEventListener('click', function(){
            if (!grid) return;
            const rows = [['Title','Room Code','Questions','Time Limit (min)']];
            document.querySelectorAll('#quiz-grid .quiz-card').forEach(card => {
                const title = card.querySelector('.quiz-title')?.textContent?.trim() || '';
                const room = card.querySelector('.room-code')?.textContent?.trim() || '';
                const details = Array.from(card.querySelectorAll('.quiz-card-details span')).map(s=>s.textContent.trim());
                const questions = (details[0]||'').replace(' Questions','');
                const time = (details[1]||'').replace(' min','');
                rows.push([title, room, questions, time]);
            });
            const csv = rows.map(r => r.map(v => '"' + (v||'').replaceAll('"','""') + '"').join(',')).join('\n');
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'quizzes.csv'; a.click();
            URL.revokeObjectURL(url);
        });
    })();
    </script>
</body>
</html>
