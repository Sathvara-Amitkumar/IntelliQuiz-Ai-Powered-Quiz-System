<!-- templates/generated_questions.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Generated Questions</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="generated-questions-page">
    <div class="generated-questions-container">
        <div class="generated-questions-header">
            <div class="generated-questions-header-top">
                <a href="{{ url_for('teacher.create_quiz') }}" class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Back to Quiz Setup
                </a>
                <div class="quiz-info">
                    <span class="badge quiz-type-badge {% if not viva %}quiz-type-mcq{% else %}quiz-type-viva{% endif %}">
                        {{ 'Multiple Choice' if not viva else 'Open-ended' }}
                    </span>
                </div>
            </div>
            <h1 class="generated-questions-title">Review Generated Questions</h1>
            <p class="generated-questions-subtitle">Review and edit the AI-generated questions before finalizing your quiz.</p>
        </div>

        {% if questions %}
        <div class="quiz-stats-bar">
            <div class="quiz-stat-item">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 11l3 3L22 4"/>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                </svg>
                <span class="quiz-stat-label">Total Questions:</span>
                <span class="quiz-stat-value">{{ questions|length }}</span>
            </div>
            <div class="quiz-stat-item">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
                <span class="quiz-stat-label">Quiz Type:</span>
                <span class="quiz-stat-value">{{ 'Multiple Choice' if not viva else 'Open-ended (Viva)' }}</span>
            </div>
        </div>
        {% endif %}

        {% if saved_files %}
        <div class="attached-files-box">
            <div class="attached-files-header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                    <polyline points="13 2 13 9 20 9"/>
                </svg>
                <strong>Attached Files</strong>
            </div>
            <div class="attached-files-list">
                {% for fname in saved_files %}
                <div class="attached-file-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                        <polyline points="13 2 13 9 20 9"/>
                    </svg>
                    {{ fname }}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if error %}
        <div class="error-message">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                <span>{{ error }}</span>
            </div>
        </div>
        {% endif %}

        {% if questions %}
        <form id="finalize-quiz-form">
            <input type="hidden" name="title" value="{{ request.form.title }}">
            <input type="hidden" name="time_limit" value="{{ request.form.time_limit }}">
            <input type="hidden" name="mode" value="{{ 'viva' if viva else 'mcq' }}">
            <!-- Persist anti-cheating selections from setup -->
            {% set ac_flags = [
                'random_question_order',
                'random_option_order',
                'plagiarism_detection',
                'strict_time_limits',
                'auto_submit',
                'speed_monitoring',
                'copy_paste_prevention',
                'tab_switch_detection',
                'fullscreen_mode',
                'duplicate_login_detection'
            ] %}
            {% for flag in ac_flags %}
            <input type="hidden" name="{{ flag }}" value="{{ 'true' if request.form.get(flag) else 'false' }}">
            {% endfor %}
            
            <div class="questions-grid">
                {% for question in questions %}
                    {% set qidx = loop.index0 %}
                    <div class="question-card">
                        <div class="question-card-header">
                            <div class="question-card-header-top">
                                <span class="question-number {% if not viva %}question-number-mcq{% else %}question-number-viva{% endif %}">
                                    Question {{ loop.index }}
                                </span>
                                <div class="question-card-actions">
                                    <button type="button" class="btn-icon edit" title="Edit this question">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                        </svg>
                                    </button>
                                    <button type="button" class="btn-icon regenerate-btn delete" title="Regenerate this question">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21.5 2v6h-6M21.34 15.57a10 10 0 1 1-.57-8.38"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="question_{{ qidx }}" class="sr-only">Question Text</label>
                                <textarea name="question_text_{{ qidx }}" id="question_{{ qidx }}" rows="3" 
                                    class="question-text-area" readonly>{{ question.text }}</textarea>
                            </div>
                        </div>

                        {% if not viva and question.options %}
                        <div class="question-card-body">
                            <div class="options-list">
                                {% for option in question.options %}
                                <div class="option-row {% if question.correct_answer is defined and question.correct_answer == loop.index0 %}selected{% endif %}">
                                    <input type="text" name="option_{{ qidx }}_{{ loop.index0 }}" 
                                        value="{{ option }}" 
                                        placeholder="Option {{ loop.index }}"
                                        class="option-input" readonly>
                                    <label class="correct-answer-label">
                                        <input type="radio" name="correct_{{ qidx }}" value="{{ loop.index0 }}" 
                                            {% if question.correct_answer is defined and question.correct_answer == loop.index0 %}checked{% endif %}>
                                        <span>Correct Answer</span>
                                        <span class="correct-badge">
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M20 6L9 17l-5-5"/>
                                            </svg>
                                            Correct
                                        </span>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% elif viva and question.answer %}
                        <div class="question-card-body">
                            <div class="viva-answer-section">
                                <div class="viva-answer-label">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                                    </svg>
                                    Expected Answer
                                </div>
                                <div class="viva-answer-text">{{ question.answer }}</div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>

            <div class="form-actions-sticky">
                <div class="form-actions-group">
                    <a href="{{ url_for('teacher.create_quiz') }}" class="btn btn-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21.5 2v6h-6M21.34 15.57a10 10 0 1 1-.57-8.38"/>
                        </svg>
                        Regenerate All
                    </a>
                </div>
                <div class="form-actions-group">
                    <button type="submit" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                            <polyline points="17 21 17 13 7 13 7 21"/>
                            <polyline points="7 3 7 8 15 8"/>
                        </svg>
                        Save Quiz
                    </button>
                </div>
            </div>
        </form>
        {% else %}
        <div class="no-questions-state">
            <svg class="no-questions-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="16" x2="12" y2="12"/>
                <line x1="12" y1="8" x2="12.01" y2="8"/>
            </svg>
            <p class="no-questions-text">No questions have been generated yet.</p>
            <a href="{{ url_for('teacher.create_quiz') }}" class="btn btn-primary">Create New Quiz</a>
        </div>
        {% endif %}
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Highlight selected correct answers
        document.querySelectorAll('input[type="radio"]').forEach(function(radio) {
            radio.addEventListener('change', function() {
                // Remove selected class from all option rows in the same question
                const questionCard = this.closest('.question-card');
                questionCard.querySelectorAll('.option-row').forEach(function(row) {
                    row.classList.remove('selected');
                });
                
                // Add selected class to the parent option row
                if (this.checked) {
                    this.closest('.option-row')?.classList.add('selected');
                }
            });
            
            // Initialize selected state
            if (radio.checked) {
                radio.closest('.option-row')?.classList.add('selected');
            }
        });
        
        const form = document.getElementById('finalize-quiz-form');
        if (form) {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(form);
                const questions = [];
                let idx = 0;
                while (formData.has(`question_text_${idx}`)) {
                    const text = formData.get(`question_text_${idx}`);
                    if (formData.get('mode') === 'viva') {
                        questions.push({ text });
                    } else {
                        const options = [];
                        let optIdx = 0;
                        while (formData.has(`option_${idx}_${optIdx}`)) {
                            options.push(formData.get(`option_${idx}_${optIdx}`));
                            optIdx++;
                        }
                        const correct = formData.get(`correct_${idx}`) || 0;
                        questions.push({ text, options, correct_answer: parseInt(correct) });
                    }
                    idx++;
                }
                const payload = {
                    title: formData.get('title'),
                    time_limit: formData.get('time_limit'),
                    mode: formData.get('mode'),
                    questions
                };
                // Include anti-cheating flags in payload
                const flags = [
                    'random_question_order',
                    'random_option_order',
                    'plagiarism_detection',
                    'strict_time_limits',
                    'auto_submit',
                    'speed_monitoring',
                    'copy_paste_prevention',
                    'tab_switch_detection',
                    'fullscreen_mode',
                    'duplicate_login_detection'
                ];
                flags.forEach(function(key){
                    const v = formData.get(key);
                    if (v !== null) payload[key] = (v === 'true' || v === 'on' || v === '1');
                });
                let result;
                try {
                    const resp = await fetch('/teacher/api/quiz/finalize', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const text = await resp.text();
                    try {
                        result = JSON.parse(text);
                    } catch (err) {
                        throw new Error('Server error: ' + text);
                    }
                    if (resp.ok) {
                        window.location.href = `/teacher/quiz/${result.quiz_id}`;
                    } else {
                        alert(result.error || 'Failed to save quiz.');
                    }
                } catch (err) {
                    alert('Unexpected error: ' + err.message);
                }
            });
        }
    });
    </script>
</body>
</html>
