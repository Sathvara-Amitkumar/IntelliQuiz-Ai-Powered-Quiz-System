<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

    <style>
        /* --- FINAL RESPONSIVE STYLES --- */
        :root {
            --color-primary: #7367F0;
            --color-primary-light: #E8E7FD;
            --color-success: #28C76F;
            --color-danger: #EA5455;
            --color-secondary: #82868B;
            --color-white: #ffffff;
            --color-light-grey: #F8F7FA;
            --color-grey: #6E6B7B;
            --color-dark-grey: #5E5873;
            --color-dark: #2C2A3A;
            --sidebar-width: 280px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--color-light-grey); color: var(--color-dark-grey); display: flex; }

        /* --- DARK SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--color-dark);
            color: var(--color-light-grey);
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            position: fixed;
            height: 100%;
            z-index: 1000;
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-brand { font-size: 1.8rem; font-weight: 700; margin-bottom: 2.5rem; color: var(--color-white); padding-left: 0.5rem; }
        .sidebar-brand span { color: var(--color-primary); }
        .sidebar-menu a { display: flex; align-items: center; color: #b0afb4; padding: 1rem 1.5rem; border-radius: 10px; margin-bottom: 0.8rem; transition: all 0.3s ease; text-decoration: none; }
        .sidebar-menu a .material-icons-sharp { margin-right: 1.2rem; font-size: 1.6rem; }
        .sidebar-menu a h4 { font-weight: 500; font-size: 1rem; margin: 0; }
        .sidebar-menu a.active, .sidebar-menu a:hover { background: var(--color-primary); color: var(--color-white); box-shadow: 0 5px 15px rgba(115, 103, 240, 0.4); }
        
        .sidebar-footer { margin-top: auto; }
        .social-icons { display: flex; justify-content: center; gap: 1.5rem; margin-bottom: 1.5rem; }
        .social-icons a { color: #b0afb4; font-size: 1.5rem; transition: color 0.3s ease; }
        .social-icons a:hover { color: var(--color-white); }
        
        /* --- MAIN CONTENT --- */
        .main-content { margin-left: var(--sidebar-width); padding: 2.5rem; width: calc(100% - var(--sidebar-width)); transition: margin-left 0.3s ease-in-out; }
        h1 { font-size: 2.5rem; font-weight: 700; color: var(--color-dark); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        
        /* Stat Cards */
        .stat-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; margin-bottom: 2.5rem; }
        .card { background: var(--color-white); padding: 2rem; border-radius: 15px; border: none; box-shadow: 0 4px 25px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 2rem; }
        .card-icon { font-size: 3rem; padding: 1.2rem; border-radius: 50%; display: flex; }
        .card-icon.students { background-color: var(--color-primary-light); color: var(--color-primary); }
        .card-icon.teachers { background-color: #d4edda; color: var(--color-success); }
        .card-info h3 { font-size: 2.8rem; font-weight: 700; color: var(--color-dark); }
        .card-info p { color: var(--color-grey); margin: 0; font-size: 1rem; }

        /* Data Section */
        .data-section { background: var(--color-white); border-radius: 15px; padding: 2rem; box-shadow: 0 4px 25px rgba(0,0,0,0.05); }
        .data-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        .data-header h2 { font-size: 1.6rem; font-weight: 600; color: var(--color-dark); }
        .action-buttons { display: flex; flex-wrap: wrap; gap: 1rem; }
        
        /* Table Styling */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 1.2rem 1rem; text-align: left; border-bottom: 1px solid #f0f0f0; vertical-align: middle; white-space: nowrap; }
        thead th { font-weight: 600; font-size: 0.9rem; color: var(--color-grey); text-transform: uppercase; letter-spacing: 0.5px; }
        tbody tr:last-child td { border-bottom: none; }
        tbody td { font-size: 1rem; }
        
        .view { display: none; }
        .view.active { display: block; }
        
        /* Buttons */
        .btn { padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; font-size: 0.95rem; border: none; cursor: pointer; transition: all 0.2s ease-in-out; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background-color: var(--color-primary); color: var(--color-white); }
        .btn-primary:hover { background-color: #6158d6; box-shadow: 0 4px 10px rgba(115, 103, 240, 0.4); }
        .btn-secondary { background-color: var(--color-secondary); color: var(--color-white); }
        .btn-secondary:hover { background-color: #707478; }
        .btn-danger { background-color: var(--color-danger); color: var(--color-white); }
        .btn-danger:hover { background-color: #d93a46; }
        .btn-outline-secondary { background-color: transparent; color: var(--color-secondary); border: 2px solid var(--color-secondary); }
        .btn-outline-secondary:hover { background-color: var(--color-secondary); color: var(--color-white); }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.85rem; }
        .btn-sm.btn-outline-primary { border: 2px solid var(--color-primary); color: var(--color-primary); background: transparent; }
        .btn-sm.btn-outline-primary:hover { background: var(--color-primary); color: var(--color-white); }
        .btn-sm.btn-outline-danger { border: 2px solid var(--color-danger); color: var(--color-danger); background: transparent; }
        .btn-sm.btn-outline-danger:hover { background: var(--color-danger); color: var(--color-white); }
        .table-actions { display: flex; gap: 0.5rem; }
        
        /* --- MOBILE RESPONSIVENESS --- */
        .mobile-menu-btn { display: none; background: none; color: var(--color-dark); font-size: 2rem; cursor: pointer; }
        
        @media (max-width: 992px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; width: 100%; }
            .mobile-menu-btn { display: block; }
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <h2 class="sidebar-brand">Intelli<span>Quiz</span></h2>
        <div class="sidebar-menu">
            <a href="#" class="nav-link active" data-view="dashboard-view"><span class="material-icons-sharp">dashboard</span><h4>Dashboard</h4></a>
            <a href="#" class="nav-link" data-view="students-view"><span class="material-icons-sharp">groups</span><h4>Students</h4></a>
            <a href="#" class="nav-link" data-view="teachers-view"><span class="material-icons-sharp">school</span><h4>Teachers</h4></a>
        </div>
        <div class="sidebar-footer">
            <div class="social-icons">
                <a href="https://www.linkedin.com" target="_blank"><i class="fab fa-linkedin"></i></a>
                <a href="https://github.com" target="_blank"><i class="fab fa-github"></i></a>
            </div>
            <a href="{{ url_for('auth.logout') }}" class="sidebar-menu"><span class="material-icons-sharp">logout</span><h4>Logout</h4></a>
        </div>
    </aside>

    <main class="main-content">
        <div class="header">
             <h1>Dashboard</h1>
             <button class="mobile-menu-btn"><span class="material-icons-sharp">menu</span></button>
        </div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}{% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show mb-4" role="alert" style="z-index: 1050;">
                {{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}{% endif %}
        {% endwith %}

        <div id="dashboard-view" class="view active"><div class="stat-cards"><div class="card"><div class="card-icon students"><span class="material-icons-sharp">groups</span></div><div class="card-info"><h3>{{ student_count }}</h3><p>Total Students</p></div></div><div class="card"><div class="card-icon teachers"><span class="material-icons-sharp">school</span></div><div class="card-info"><h3>{{ teacher_count }}</h3><p>Total Teachers</p></div></div></div></div>
        <div id="students-view" class="view"><div class="data-section"><div class="data-header"><h2>Student Management</h2><div class="action-buttons"><a href="{{ url_for('admin.create_user') }}" class="btn btn-primary">Create User</a><button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#resendCredentialsModal">Resend Credentials</button><button id="import-csv-btn-student" class="btn btn-outline-secondary">Import CSV</button><form action="{{ url_for('admin.refresh_passwords', role='student') }}" method="POST" onsubmit="return confirm('Are you sure? This will reset all student passwords.');"><button type="submit" class="btn btn-danger">Refresh Passwords</button></form></div></div><div class="table-responsive"><table><thead><tr><th>Username</th><th>Email</th><th>Password</th><th>Actions</th></tr></thead><tbody>{% for user in students %}<tr><td>{{ user.username }}</td><td>{{ user.email }}</td><td>{{ user.password }}</td><td><div class="table-actions"><a href="{{ url_for('admin.edit_user', user_id=user.id) }}" class="btn btn-sm btn-outline-primary">Edit</a><form action="{{ url_for('admin.delete_user', user_id=user.id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this user?');"><button type="submit" class="btn btn-sm btn-outline-danger">Delete</button></form></div></td></tr>{% else %}<tr><td colspan="4" class="text-center p-5">No students found.</td></tr>{% endfor %}</tbody></table></div></div></div>
        <div id="teachers-view" class="view"><div class="data-section"><div class="data-header"><h2>Teacher Management</h2><div class="action-buttons"><a href="{{ url_for('admin.create_user') }}" class="btn btn-primary">Create User</a><button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#resendCredentialsModal">Resend Credentials</button><button id="import-csv-btn-teacher" class="btn btn-outline-secondary">Import CSV</button><form action="{{ url_for('admin.refresh_passwords', role='teacher') }}" method="POST" onsubmit="return confirm('Are you sure? This will reset all teacher passwords.');"><button type="submit" class="btn btn-danger">Refresh Passwords</button></form></div></div><div class="table-responsive"><table><thead><tr><th>Username</th><th>Email</th><th>Password</th><th>Actions</th></tr></thead><tbody>{% for user in teachers %}<tr><td>{{ user.username }}</td><td>{{ user.email }}</td><td>{{ user.password }}</td><td><div class="table-actions"><a href="{{ url_for('admin.edit_user', user_id=user.id) }}" class="btn btn-sm btn-outline-primary">Edit</a><form action="{{ url_for('admin.delete_user', user_id=user.id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this user?');"><button type="submit" class="btn btn-sm btn-outline-danger">Delete</button></form></div></td></tr>{% else %}<tr><td colspan="4" class="text-center p-5">No teachers found.</td></tr>{% endfor %}</tbody></table></div></div></div>
    </main>

    <div class="modal fade" id="resendCredentialsModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Resend User Credentials</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><form action="{{ url_for('admin.send_mail_route') }}" method="post"><div class="modal-body"><p>Select recipient to resend credentials.</p><div class="mb-3"><label for="recipient" class="form-label">Recipient</label><select class="form-select" id="recipient" name="recipient" required><option value="all_students">All Students</option><option value="all_teachers">All Teachers</option><option value="specific_user">Specific User</option></select></div><div class="mb-3" id="specific_user_email_div" style="display:none;"><label for="specific_user_email" class="form-label">User Email</label><input type="email" class="form-control" id="specific_user_email" name="specific_user_email"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="submit" class="btn btn-primary">Send Credentials</button></div></form></div></div></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.querySelector('.sidebar');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            
            // --- NEW: Mobile Menu Toggle ---
            menuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('open');
            });
            
            const navLinks = document.querySelectorAll('.nav-link');
            const views = document.querySelectorAll('.view');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navLinks.forEach(item => item.classList.remove('active'));
                    link.classList.add('active');
                    const viewId = link.getAttribute('data-view');
                    const targetView = document.getElementById(viewId);
                    
                    const headerText = targetView.querySelector('h2') ? targetView.querySelector('h2').textContent : 'Dashboard';
                    document.querySelector('.main-content h1').textContent = headerText;

                    views.forEach(view => { view.classList.remove('active'); });
                    targetView.classList.add('active');
                    sidebar.classList.remove('open'); // Close sidebar on link click
                });
            });

            function handleCsvImport(event) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.csv';
                input.onchange = e => {
                    if (e.target.files.length === 0) return;
                    const formData = new FormData();
                    formData.append('file', e.target.files[0]);
                    
                    // This fetch call now correctly matches the Python route
                    fetch('{{ url_for("admin.import_users") }}', { 
                        method: 'POST', 
                        body: formData 
                    })
                    .then(res => res.json()).then(data => {
                        alert(data.error || data.message);
                        if (!data.error) {
                            window.location.reload();
                        }
                    }).catch(() => alert('An unexpected error occurred.'));
                };
                input.click();
            }
            document.getElementById('import-csv-btn-student')?.addEventListener('click', handleCsvImport);
            document.getElementById('import-csv-btn-teacher')?.addEventListener('click', handleCsvImport);
            
            document.getElementById('recipient').addEventListener('change', function () {
                document.getElementById('specific_user_email_div').style.display = (this.value === 'specific_user') ? 'block' : 'none';
            });
        });
    </script>
</body>
</html>